<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منظم جدول الحصص - تصميم عصري</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Libraries for Image Download & Drag-and-Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Base Styles & Font --- */
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Cairo', sans-serif; 
            -webkit-user-select: none; -ms-user-select: none; user-select: none; 
            background-color: #0D1117; /* Dark base for the aurora */
            color: #E6EDF3; /* Brighter default text */
            overflow-x: hidden; /* Prevent horizontal scroll from aurora */
        }
        input, textarea, select { -webkit-user-select: text; -ms-user-select: text; user-select: text; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* --- Animated Aurora Background --- */
        #aurora-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            opacity: 0.4;
        }
        .aurora-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            mix-blend-mode: screen;
        }
        .aurora-1 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, #3b82f6, transparent 60%);
            top: 10%; left: 15%;
            animation: move-aurora-1 25s infinite alternate ease-in-out;
        }
        .aurora-2 {
            width: 350px; height: 350px;
            background: radial-gradient(circle, #a855f7, transparent 60%);
            top: 40%; right: 10%;
            animation: move-aurora-2 30s infinite alternate ease-in-out;
        }
        .aurora-3 {
            width: 300px; height: 300px;
            background: radial-gradient(circle, #14b8a6, transparent 60%);
            bottom: 5%; left: 30%;
            animation: move-aurora-3 20s infinite alternate ease-in-out;
        }

        @keyframes move-aurora-1 {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(100px, 50px) rotate(45deg); }
        }
        @keyframes move-aurora-2 {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-80px, -60px) rotate(-60deg); }
        }
        @keyframes move-aurora-3 {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(50px, -70px) rotate(30deg); }
        }

        /* --- Glassmorphism Card Style --- */
        .card {
            background-color: rgba(28, 32, 38, 0.6); /* Darker, more transparent glass */
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* --- Typography & UI Elements --- */
        .text-pop {
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
        }
        
        /* --- Table Styles (for schedule page) --- */
        .schedule-table { border-collapse: collapse; width: 100%; color: #1f2937; }
        .schedule-table th, .schedule-table td { border: 1px solid #9ca3af; padding: 4px; text-align: center; font-weight: 600; vertical-align: middle; }
        .schedule-table thead th { background-color: #e5e7eb; font-weight: 700; position: sticky; top: 0; z-index: 10; border-color: #6b7280; }
        .day-cell { font-weight: 700; font-size: 1.1rem; }
        .period-cell { font-weight: 700; }
        .session-cell, .teacher-cell, .empty-cell { height: 60px; }
        .day-row-0 { background-color: #fef9c3; } .day-row-1 { background-color: #dcfce7; } .day-row-2 { background-color: #dbeafe; } .day-row-3 { background-color: #e9d5ff; } .day-row-4 { background-color: #fce7f3; }
        .day-row-0 .day-cell { background-color: #fde047; } .day-row-1 .day-cell { background-color: #86efac; } .day-row-2 .day-cell { background-color: #93c5fd; } .day-row-3 .day-cell { background-color: #c4b5fd; } .day-row-4 .day-cell { background-color: #f9a8d4; }
        .day-row-0 .period-cell, .day-row-1 .period-cell, .day-row-2 .period-cell, .day-row-3 .period-cell, .day-row-4 .period-cell { background-color: rgba(255, 255, 255, 0.6); }

        #page-schedule.full-screen { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background-color: #f3f4f6; 
            z-index: 50; 
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        
        .session-cell { cursor: grab; }
        .session-cell:active { cursor: grabbing; }
        .session-cell.sortable-ghost { background: #4ade80; opacity: 0.7; border: 2px dashed #15803d; }
        .teacher-cell { color: #4b5563; font-size: 0.9em; }

        #toast-notification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: white; font-weight: bold;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }
        #toast-notification.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }
        #toast-notification.success { background-color: #22c55e; }
        #toast-notification.error { background-color: #ef4444; }
    </style>
</head>
<body class="text-gray-200" oncontextmenu="return false;">

    <div id="aurora-background">
        <div class="aurora-shape aurora-1"></div>
        <div class="aurora-shape aurora-2"></div>
        <div class="aurora-shape aurora-3"></div>
    </div>

    <div id="app">
        <!-- Auth Pages -->
        <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-4">
            <div class="w-full max-w-md">
                <div id="page-landing">
                    <div class="text-center bg-white/90 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-gray-200">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">أهلاً بك في منظم الجداول</h1>
                        <p class="text-gray-500 mb-8">تم الانشاء بواسطة احمد فلاح</p>
                        <div class="space-y-4">
                            <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition flex items-center justify-center gap-3">
                                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.528-3.474-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C39.99,34.556,44,29.865,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                                <span>التسجيل / الدخول عبر Google</span>
                            </button>
                            <div class="relative flex py-2 items-center">
                                <div class="flex-grow border-t border-gray-300"></div>
                                <span class="flex-shrink mx-4 text-gray-400 text-sm">أو</span>
                                <div class="flex-grow border-t border-gray-300"></div>
                            </div>
                            <button id="goto-login-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">تسجيل الدخول</button>
                        </div>
                        <p class="text-gray-600 text-sm mt-6">للتواصل مع المسؤول، <a href="https://t.me/ahmedyakuz" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-semibold hover:underline">انقر هنا</a>.</p>
                    </div>
                </div>
                <div id="page-login" class="hidden">
                     <div class="bg-white/90 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">تسجيل الدخول</h2>
                        <form id="login-form" class="space-y-4">
                            <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full p-3 bg-gray-100 border rounded-lg text-center text-gray-800" required>
                            <input type="password" id="login-password" placeholder="كلمة المرور" class="w-full p-3 bg-gray-100 border rounded-lg text-center text-gray-800" required>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">دخول</button>
                            <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
                            <button type="button" id="goto-reset-btn" class="w-full text-sm text-gray-500 hover:text-blue-600 pt-2">هل نسيت كلمة المرور؟</button>
                            <button type="button" id="back-to-landing-1" class="w-full text-sm text-gray-500 hover:text-blue-600 pt-2">العودة</button>
                        </form>
                        <p class="text-gray-600 text-sm mt-6 text-center">للتواصل مع المسؤول، <a href="https://t.me/ahmedyakuz" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-semibold hover:underline">انقر هنا</a>.</p>
                    </div>
                </div>
                <div id="page-reset" class="hidden">
                    <div class="bg-white/90 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">إعادة تعيين كلمة المرور</h2>
                        <form id="reset-form" class="space-y-4">
                            <p class="text-sm text-gray-600 text-center">أدخل بريدك الإلكتروني المسجل لإرسال رابط إعادة التعيين.</p>
                            <input type="email" id="reset-email" placeholder="البريد الإلكتروني" class="w-full p-3 bg-gray-100 border rounded-lg text-center text-gray-800" required>
                            <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition">إرسال رابط إعادة التعيين</button>
                            <p id="reset-error" class="text-red-500 text-sm text-center hidden"></p>
                            <p id="reset-success" class="text-green-500 text-sm text-center hidden"></p>
                            <button type="button" id="back-to-login-btn" class="w-full text-sm text-gray-500 hover:text-blue-600 pt-2">العودة لتسجيل الدخول</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Approval Page -->
        <div id="pending-approval-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center">
            <div class="card p-8 max-w-lg">
                <i class="fas fa-hourglass-half text-5xl text-amber-400 mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2 text-pop">الحساب قيد المراجعة</h1>
                <p class="text-gray-300 mb-6">تم استلام طلبك بنجاح. سيتم تفعيل حسابك قريباً بعد مراجعته من قبل المسؤول.</p>
                <button id="logout-pending-btn" class="bg-red-600/80 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-500/100 transition">تسجيل الخروج</button>
            </div>
        </div>
        
        <!-- Expired Subscription Page -->
        <div id="expired-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center">
            <div class="card p-8 max-w-lg">
                <i class="fas fa-calendar-times text-5xl text-red-400 mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2 text-pop">انتهت صلاحية اشتراكك</h1>
                <p class="text-gray-300 mb-6">نأسف، لقد انتهت صلاحية اشتراكك في المنصة. يرجى التواصل مع المسؤول لتجديد الاشتراك.</p>
                <button id="logout-expired-btn" class="bg-red-600/80 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-500/100 transition">تسجيل الخروج</button>
            </div>
        </div>

        <!-- Main App Page -->
        <div id="main-app-container" class="hidden min-h-screen w-full flex flex-col p-4 md:p-6 lg:p-8">
            <header class="w-full flex justify-between items-center mb-6 pb-4 border-b border-gray-700/50">
                <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-wider text-pop">منصة تنظيم الجداول</h1>
                <div class="flex items-center gap-3">
                    <button id="admin-panel-btn" class="hidden bg-teal-500/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-500/100 transition-all duration-300 hover:shadow-[0_0_15px_rgba(20,184,166,0.5)] flex items-center gap-2 text-pop"><i class="fas fa-user-shield"></i><span>إدارة المستخدمين</span></button>
                    <button id="show-last-schedule-btn" class="bg-yellow-500/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-500/100 transition-all duration-300 hover:shadow-[0_0_15px_rgba(234,179,8,0.5)] disabled:bg-gray-600 disabled:cursor-not-allowed disabled:shadow-none flex items-center gap-2 text-pop" disabled><i class="fas fa-history"></i><span>آخر جدول</span></button>
                    <button id="trash-btn" class="bg-gray-600/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500/100 transition-all duration-300 hover:shadow-[0_0_15px_rgba(156,163,175,0.4)] flex items-center gap-2 text-pop"><i class="fas fa-trash-alt"></i><span>السلة</span></button>
                    <button id="logout-btn" class="bg-red-600/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-500/100 transition-all duration-300 hover:shadow-[0_0_15px_rgba(239,68,68,0.5)] flex items-center gap-2 text-pop"><i class="fas fa-sign-out-alt"></i><span>خروج</span></button>
                </div>
            </header>
            
            <div class="mb-6 card p-4">
                <label for="stage-selector" class="block text-lg font-bold mb-2 text-white text-pop">اختر المرحلة الدراسية للعمل عليها:</label>
                <select id="stage-selector" class="w-full p-3 bg-gray-900/50 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 transition text-white text-xl">
                    <option value="">-- يرجى اختيار مرحلة --</option>
                    <option value="primary">ابتدائية</option>
                    <option value="intermediate">متوسطة</option>
                    <option value="preparatory">إعدادية</option>
                </select>
            </div>

            <div id="stage-content-container" class="hidden flex-grow grid grid-cols-1 lg:grid-cols-3 gap-8">
                <aside class="lg:col-span-1 card p-6 flex flex-col space-y-6">
                    <h2 class="text-2xl font-bold text-white border-b border-gray-700/50 pb-3 text-pop">لوحة المعلومات</h2>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-sky-500/10 p-4 rounded-xl border border-sky-500/20">
                            <p class="text-4xl font-bold text-sky-300 text-pop" id="teacher-count-stat">0</p>
                            <p class="text-sm text-gray-300 mt-1 text-pop">معلم</p>
                        </div>
                        <div class="bg-fuchsia-500/10 p-4 rounded-xl border border-fuchsia-500/20">
                            <p class="text-4xl font-bold text-fuchsia-300 text-pop" id="session-count-stat">0</p>
                            <p class="text-sm text-gray-300 mt-1 text-pop">حصة</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg text-white mb-3 text-pop">آخر الإضافات</h3>
                        <ul id="last-teachers-list" class="space-y-2 text-gray-300 bg-black/20 p-3 rounded-lg min-h-[100px]">
                           <li class="text-center text-gray-400 text-pop">لا توجد بيانات بعد.</li>
                        </ul>
                    </div>
                    <div class="flex-grow"></div>
                    <button id="show-teachers-modal-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-500 transition-all duration-300 hover:shadow-[0_0_20px_rgba(129,140,248,0.6)] flex items-center justify-center gap-2 text-pop">
                        <i class="fas fa-users"></i>
                        <span>عرض كل المعلمين</span>
                    </button>
                </aside>

                <main class="lg:col-span-2 flex flex-col gap-8">
                    <div id="page-input" class="card p-8 flex-grow flex flex-col">
                        <h2 class="text-2xl font-bold mb-6 border-b border-gray-700/50 pb-4 text-white text-pop">إضافة نصاب معلم جديد</h2>
                        <form id="add-teacher-form" class="flex-grow flex flex-col space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="teacher-select" class="block text-sm font-semibold mb-2 text-gray-300 text-pop">اسم المعلم</label>
                                    <select id="teacher-select" class="w-full p-3 bg-gray-900/50 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 transition text-white"></select>
                                    <input type="text" id="new-teacher-name" placeholder="اكتب اسم المعلم الجديد هنا" class="w-full p-3 mt-2 bg-gray-900/50 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 transition text-white hidden">
                                </div>
                                <div>
                                    <label for="subject" class="block text-sm font-semibold mb-2 text-gray-300 text-pop">المادة</label>
                                    <input type="text" id="subject" placeholder="مثال: رياضيات" class="w-full p-3 bg-gray-900/50 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 transition text-white">
                                </div>
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg border border-gray-700">
                                <h3 class="text-lg font-bold mb-4 text-white text-pop">تحديد الصفوف والحصص للمرحلة الحالية</h3>
                                <div id="classes-container" class="mt-4 space-y-3"></div>
                            </div>
                            <div class="flex-grow"></div>
                            <div class="text-center pt-4">
                                <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_20px_rgba(59,130,246,0.6)] text-pop">
                                    <i class="fas fa-plus-circle mr-2"></i>إضافة النصاب للقائمة
                                </button>
                            </div>
                        </form>
                    </div>
                    <button id="generate-schedule-btn" class="w-full bg-green-600 text-white font-extrabold text-xl py-5 px-12 rounded-2xl hover:bg-green-500 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-green-500 transition-all duration-300 transform hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:transform-none hover:shadow-[0_0_25px_rgba(34,197,94,0.6)] disabled:shadow-none text-pop" disabled>
                        <i class="fas fa-cogs mr-3"></i>توليد وعرض الجدول
                    </button>
                </main>
            </div>
        </div>

        <!-- Schedule Display Page -->
        <section id="page-schedule" class="hidden">
            <header class="flex-shrink-0 flex justify-between items-center mb-4 no-print">
                <div><h1 class="text-3xl md:text-4xl font-bold text-gray-800" id="schedule-page-title">الجدول الأسبوعي</h1></div>
                <div class="flex items-center gap-2">
                    <button id="show-stats-btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition"><i class="fas fa-chart-pie mr-2"></i>عرض الإحصائيات</button>
                    <button id="regenerate-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition"><i class="fas fa-random mr-2"></i>اقتراح آخر</button>
                    <button id="download-image-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-download mr-2"></i>تحميل صورة</button>
                    <button id="back-to-main-app-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition"><i class="fas fa-arrow-right mr-2"></i>رجوع</button>
                </div>
            </header>
            <div class="flex-grow overflow-auto bg-white rounded-lg shadow-md p-2">
                <div id="schedule-print-area">
                    <h2 id="print-title" class="text-2xl font-bold text-center my-4 text-gray-800">الجدول الدراسي الأسبوعي</h2>
                    <div id="schedule-container" class="overflow-x-auto"></div>
                </div>
            </div>
            <div id="unscheduled-sessions" class="flex-shrink-0 mt-4 bg-red-50 border border-red-200 p-4 rounded-lg hidden no-print"><h3 class="font-bold text-red-700">حصص لم يتم جدولتها</h3><p class="text-red-600 text-sm">قد يكون السبب هو وجود تعارضات شديدة أو عدم وجود فراغات كافية.</p><ul id="unscheduled-list" class="list-disc pr-5 mt-2 text-red-800"></ul></div>
        </section>

        <!-- Modals -->
        <div id="admin-panel-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
            <div class="bg-gray-800/80 text-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[80vh] flex flex-col border border-gray-600">
                <header class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">إدارة المستخدمين</h2><button id="close-admin-panel-btn" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button></header>
                <div id="admin-user-list" class="p-6 space-y-3 overflow-y-auto"></div>
            </div>
        </div>
        <div id="teachers-data-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
            <div class="bg-gray-800/80 text-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[80vh] flex flex-col border border-gray-600">
                <header class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">بيانات المعلمين</h2><button id="close-teachers-data-modal-btn" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button></header>
                <div id="teachers-data-list" class="p-6 space-y-3 overflow-y-auto"></div>
            </div>
        </div>
        <div id="edit-teacher-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
            <div class="bg-gray-800/80 text-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col border border-gray-600">
                <header class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">تعديل بيانات المعلم</h2><button id="close-edit-teacher-modal-btn" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button></header>
                <div id="edit-teacher-form-container" class="p-6 overflow-y-auto"></div>
            </div>
        </div>
        <div id="trash-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
            <div class="bg-gray-800/80 text-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col border border-gray-600">
                <header class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">سلة المهملات</h2><button id="close-trash-modal-btn" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button></header>
                <div id="trash-list" class="p-6 space-y-3 overflow-y-auto"></div>
                 <footer class="p-2 text-center text-xs text-gray-500 border-t border-gray-700">سيتم حذف العناصر نهائياً بعد 7 أيام من نقلها للسلة.</footer>
            </div>
        </div>
        <div id="stats-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
            <div class="bg-gray-800/80 text-white rounded-2xl shadow-xl w-full max-w-7xl max-h-[90vh] flex flex-col border border-gray-600">
                <header class="p-4 border-b border-gray-700 flex justify-between items-center"><h2 class="text-xl font-bold">تقارير وإحصائيات الجدول</h2><button id="close-stats-modal-btn" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button></header>
                <div class="p-6 overflow-y-auto">
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-bold mb-4">توزيع الحصص على المعلمين (رسم بياني)</h3>
                            <div class="w-full h-96 bg-gray-700/50 p-4 rounded-lg"><canvas id="teacher-load-chart"></canvas></div>
                        </div>
                        <div id="teacher-stats-details-container" class="max-h-[70vh] overflow-y-auto pr-2">
                            <h3 class="text-lg font-bold mb-4">تفاصيل نصاب المعلمين</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="toast-notification"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        signOut,
        GoogleAuthProvider,
        signInWithPopup,
        sendPasswordResetEmail,
        createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, Timestamp, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // FIXED: Removed the ADMIN_UIDS array. Admin status is now checked via a 'role' field in the user's document.
    // const ADMIN_UIDS = ["Il0raooy1sflVpiwiWBHw67nuBl1"]; 

    const firebaseConfig = {
        apiKey: "AIzaSyDjBTbZTjIgXY8j0Gkhgj0BKTUEUvGPUAQ",
        authDomain: "my-table-9513b.firebaseapp.com",
        projectId: "my-table-9513b",
        storageBucket: "my-table-9513b.appspot.com",
        messagingSenderId: "71523627547",
        appId: "1:71523627547:web:ebf11495e30fe0f6117ebe"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    document.addEventListener('DOMContentLoaded', () => {
        const mainAppContainer = document.getElementById('main-app-container');
        const authContainer = document.getElementById('auth-container');
        const pendingApprovalContainer = document.getElementById('pending-approval-container');
        const expiredContainer = document.getElementById('expired-container');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const adminPanelModal = document.getElementById('admin-panel-modal');
        const closeAdminPanelBtn = document.getElementById('close-admin-panel-btn');
        const adminUserList = document.getElementById('admin-user-list');
        const logoutPendingBtn = document.getElementById('logout-pending-btn');
        const logoutExpiredBtn = document.getElementById('logout-expired-btn');
        const pageSchedule = document.getElementById('page-schedule');
        const stageSelector = document.getElementById('stage-selector');
        const stageContentContainer = document.getElementById('stage-content-container');
        const classesContainer = document.getElementById('classes-container');
        const addTeacherForm = document.getElementById('add-teacher-form');
        const generateScheduleBtn = document.getElementById('generate-schedule-btn');
        const scheduleContainer = document.getElementById('schedule-container');
        const backToMainAppBtn = document.getElementById('back-to-main-app-btn');
        const downloadImageBtn = document.getElementById('download-image-btn');
        const regenerateBtn = document.getElementById('regenerate-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const trashBtn = document.getElementById('trash-btn');
        const trashModal = document.getElementById('trash-modal');
        const closeTrashModalBtn = document.getElementById('close-trash-modal-btn');
        const trashListDiv = document.getElementById('trash-list');
        const statsModal = document.getElementById('stats-modal');
        const showStatsBtn = document.getElementById('show-stats-btn');
        const closeStatsModalBtn = document.getElementById('close-stats-modal-btn');
        const toast = document.getElementById('toast-notification');
        const showTeachersModalBtn = document.getElementById('show-teachers-modal-btn');
        const teachersDataModal = document.getElementById('teachers-data-modal');
        const closeTeachersDataModalBtn = document.getElementById('close-teachers-data-modal-btn');
        const teachersDataList = document.getElementById('teachers-data-list');
        const editTeacherModal = document.getElementById('edit-teacher-modal');
        const closeEditTeacherModalBtn = document.getElementById('close-edit-teacher-modal-btn');
        const showLastScheduleBtn = document.getElementById('show-last-schedule-btn');
        const teacherSelect = document.getElementById('teacher-select');
        const newTeacherNameInput = document.getElementById('new-teacher-name');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const pageReset = document.getElementById('page-reset');
        const gotoResetBtn = document.getElementById('goto-reset-btn');
        const resetForm = document.getElementById('reset-form');
        const backToLoginBtn = document.getElementById('back-to-login-btn');

        let currentUser = null;
        let isDataLoaded = false;
        let currentStage = '';
        let dataByStage = {};
        let trashedTeachers = [];
        let teacherStatsChart = null;
        let sortableInstance = null;

        const getInitialStageData = () => ({
            teachers: [],
            lastSchedule: null
        });

        const hideAllContainers = () => {
            authContainer.classList.add('hidden');
            mainAppContainer.classList.add('hidden');
            mainAppContainer.classList.remove('flex');
            pendingApprovalContainer.classList.add('hidden');
            pendingApprovalContainer.classList.remove('flex');
            expiredContainer.classList.add('hidden');
            expiredContainer.classList.remove('flex');
        };

        onAuthStateChanged(auth, async (user) => {
            hideAllContainers();
            isDataLoaded = false;
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    // FIXED: Added 'role: "user"' when creating a new user document
                    // This is required by the new security rules.
                    await setDoc(userDocRef, { 
                        email: user.email, 
                        status: 'pending', 
                        role: 'user', // Default role for new users
                        createdAt: Timestamp.now() 
                    });
                    pendingApprovalContainer.classList.remove('hidden');
                    pendingApprovalContainer.classList.add('flex');
                } else {
                    const userData = userDoc.data();
                    const now = Timestamp.now();

                    if (userData.status === 'approved' && userData.expiryDate && userData.expiryDate.toMillis() < now.toMillis() && userData.subscriptionType !== 'lifetime') {
                        await updateDoc(userDocRef, { status: 'expired' });
                        expiredContainer.classList.remove('hidden');
                        expiredContainer.classList.add('flex');
                    } else if (userData.status === 'approved') {
                        mainAppContainer.classList.remove('hidden');
                        mainAppContainer.classList.add('flex');
                        // FIXED: Check for admin role from the user document data, not a static array.
                        adminPanelBtn.classList.toggle('hidden', userData.role !== 'admin');
                        await loadUserData();
                    } else if (userData.status === 'pending') {
                        pendingApprovalContainer.classList.remove('hidden');
                        pendingApprovalContainer.classList.add('flex');
                    } else if (userData.status === 'expired') {
                        expiredContainer.classList.remove('hidden');
                        expiredContainer.classList.add('flex');
                    } else {
                        authContainer.classList.remove('hidden');
                        showToast('تم رفض حسابك أو أنه غير نشط.', 'error');
                        await signOut(auth);
                    }
                }
            } else {
                currentUser = null;
                dataByStage = {};
                trashedTeachers = [];
                currentStage = '';
                stageSelector.value = '';
                stageContentContainer.classList.add('hidden');
                updateAllUI();
                authContainer.classList.remove('hidden');
                document.getElementById('page-login').classList.add('hidden');
                pageReset.classList.add('hidden');
                document.getElementById('page-landing').classList.remove('hidden');
            }
        });
        
        document.getElementById('goto-login-btn').addEventListener('click', () => { document.getElementById('page-landing').classList.add('hidden'); document.getElementById('page-login').classList.remove('hidden'); });
        document.getElementById('back-to-landing-1').addEventListener('click', () => { document.getElementById('page-login').classList.add('hidden'); document.getElementById('page-landing').classList.remove('hidden'); });
        gotoResetBtn.addEventListener('click', () => { document.getElementById('page-login').classList.add('hidden'); pageReset.classList.remove('hidden'); });
        backToLoginBtn.addEventListener('click', () => { pageReset.classList.add('hidden'); document.getElementById('page-login').classList.remove('hidden'); });

        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("Google Sign-In Error:", error); showToast("فشل التسجيل عبر جوجل.", "error"); }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');
            try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { errorEl.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة."; errorEl.classList.remove('hidden'); }
        });

        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            const errorEl = document.getElementById('reset-error');
            const successEl = document.getElementById('reset-success');
            errorEl.classList.add('hidden'); successEl.classList.add('hidden');
            try { await sendPasswordResetEmail(auth, email); successEl.textContent = "تم إرسال رابط إعادة التعيين إلى بريدك الإلكتروني."; successEl.classList.remove('hidden'); } catch (error) { console.error("Password Reset Error:", error); errorEl.textContent = "حدث خطأ. يرجى التأكد من البريد الإلكتروني."; errorEl.classList.remove('hidden'); }
        });

        logoutBtn.addEventListener('click', async () => { await signOut(auth); });
        logoutPendingBtn.addEventListener('click', async () => { await signOut(auth); });
        logoutExpiredBtn.addEventListener('click', async () => { await signOut(auth); });

        adminPanelBtn.addEventListener('click', async () => {
            adminPanelModal.classList.remove('hidden');
            await loadUsersForAdmin();
        });
        closeAdminPanelBtn.addEventListener('click', () => adminPanelModal.classList.add('hidden'));

        async function loadUsersForAdmin() {
            adminUserList.innerHTML = '<p>جاري تحميل المستخدمين...</p>';
            try {
                const usersCollection = collection(db, "users");
                const userSnapshot = await getDocs(usersCollection);
                const users = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const getStatusClass = (status) => {
                    if (status === 'approved') return 'text-green-400';
                    if (status === 'pending') return 'text-amber-400';
                    if (status === 'expired') return 'text-yellow-500';
                    return 'text-red-400';
                };

                const formatExpiry = (expiry) => {
                    if (!expiry) return 'N/A';
                    if (expiry.toDate) {
                        return expiry.toDate().toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
                    }
                    return 'N/A';
                };
                
                let html = '';
                const sections = {
                    pending: { title: 'طلبات قيد المراجعة', users: [], color: 'text-amber-400' },
                    approved: { title: 'المستخدمون النشطون', users: [], color: 'text-green-400' },
                    expired: { title: 'الاشتراكات المنتهية', users: [], color: 'text-yellow-500' },
                    rejected: { title: 'المستخدمون المرفوضون', users: [], color: 'text-red-400' },
                };

                users.forEach(u => {
                    if (sections[u.status]) sections[u.status].users.push(u);
                });

                for (const key in sections) {
                    const section = sections[key];
                    html += `<h3 class="text-lg font-bold ${section.color} mt-6 mb-2">${section.title} (${section.users.length})</h3>`;
                    if (section.users.length > 0) {
                        section.users.forEach(user => {
                            const isMonthlyActive = user.subscriptionType === 'monthly' && user.status === 'approved';
                            const isYearlyActive = user.subscriptionType === 'yearly' && user.status === 'approved';
                            const isLifetimeActive = user.subscriptionType === 'lifetime' && user.status === 'approved';
                            // FIXED: Check for admin role from user data, not a static array.
                            const isAdmin = user.role === 'admin';

                            html += `<div class="grid grid-cols-3 items-center gap-4 p-3 bg-gray-900/50 rounded-lg">
                                <div class="col-span-1">
                                    <p class="font-semibold truncate">${user.email}</p>
                                    <p class="text-xs ${getStatusClass(user.status)}">
                                        ${isLifetimeActive ? 'اشتراك مدى الحياة' : user.expiryDate ? `ينتهي في: ${formatExpiry(user.expiryDate)}` : 'غير مفعل'}
                                        ${isAdmin ? '<span class="text-xs text-teal-400 ml-2">(مسؤول)</span>' : ''}
                                    </p>
                                </div>
                                <div class="col-span-2 flex gap-2 items-center justify-end">
                                    <button data-uid="${user.id}" data-email="${user.email}" data-type="monthly" class="sub-btn ${isMonthlyActive ? 'bg-green-500' : 'bg-gray-600 hover:bg-gray-500'} text-white text-xs font-bold py-1 px-3 rounded-md transition flex items-center gap-1">${isMonthlyActive ? '<i class="fas fa-check"></i>' : ''} شهري</button>
                                    <button data-uid="${user.id}" data-email="${user.email}" data-type="yearly" class="sub-btn ${isYearlyActive ? 'bg-green-500' : 'bg-gray-600 hover:bg-gray-500'} text-white text-xs font-bold py-1 px-3 rounded-md transition flex items-center gap-1">${isYearlyActive ? '<i class="fas fa-check"></i>' : ''} سنوي</button>
                                    <button data-uid="${user.id}" data-email="${user.email}" data-type="lifetime" class="sub-btn ${isLifetimeActive ? 'bg-green-500' : 'bg-gray-600 hover:bg-gray-500'} text-white text-xs font-bold py-1 px-3 rounded-md transition flex items-center gap-1">${isLifetimeActive ? '<i class="fas fa-check"></i>' : ''} مدى الحياة</button>
                                    ${!isAdmin ? `<button data-uid="${user.id}" class="delete-btn bg-red-800 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-md transition"><i class="fas fa-trash-alt"></i></button>` : ''}
                                </div>
                            </div>`;
                        });
                    } else {
                        html += '<p class="text-gray-400">لا يوجد مستخدمون في هذا القسم.</p>';
                    }
                }

                adminUserList.innerHTML = html;
                
                document.querySelectorAll('.sub-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                    const { uid, email, type } = e.currentTarget.dataset;
                    const userDoc = await getDoc(doc(db, "users", uid));
                    const currentSub = userDoc.data().subscriptionType;
                    const currentStatus = userDoc.data().status;

                    if (currentSub === type && currentStatus === 'approved') {
                        await updateUserStatus(uid, email, 'rejected', 'الاشتراك ملغي');
                    } else {
                        await activateUserSubscription(uid, email, type);
                    }
                }));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                    const { uid } = e.currentTarget.dataset;
                    if(confirm('هل أنت متأكد من حذف هذا المستخدم نهائياً؟ لا يمكن التراجع عن هذا الإجراء.')) {
                        await deleteUserPermanently(uid);
                    }
                }));
            } catch (error) {
                console.error("Error loading users for admin:", error);
                adminUserList.innerHTML = '<p class="text-red-400">فشل في تحميل المستخدمين. قد تكون هناك مشكلة في صلاحيات الوصول.</p>';
            }
        }

        async function activateUserSubscription(uid, email, type) {
            const now = new Date();
            let expiryDate = null;

            if (type === 'monthly') {
                expiryDate = new Date(now.setMonth(now.getMonth() + 1));
            } else if (type === 'yearly') {
                expiryDate = new Date(now.setFullYear(now.getFullYear() + 1));
            }

            const userDocRef = doc(db, "users", uid);
            await updateDoc(userDocRef, {
                status: 'approved',
                subscriptionType: type,
                activationDate: Timestamp.now(),
                expiryDate: type !== 'lifetime' ? Timestamp.fromDate(expiryDate) : null
            });
            
            showToast(`تم تفعيل اشتراك المستخدم (${type}) بنجاح.`, 'success');
            await loadUsersForAdmin();
        }

        async function updateUserStatus(uid, email, status, reason = 'مرفوض') {
            const userDocRef = doc(db, "users", uid);
            await updateDoc(userDocRef, { 
                status: status,
                subscriptionType: null,
                expiryDate: null
            });
            showToast(`تم ${reason} للمستخدم بنجاح.`, 'success');
            await loadUsersForAdmin();
        }

        async function deleteUserPermanently(uid) {
            const userDocRef = doc(db, "users", uid);
            await deleteDoc(userDocRef);
            showToast(`تم حذف المستخدم نهائياً.`, 'success');
            await loadUsersForAdmin();
        }

        async function loadUserData() {
            if (!currentUser) return;
            const userDocRef = doc(db, "users", currentUser.uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    dataByStage = userData.dataByStage || {
                        primary: getInitialStageData(),
                        intermediate: getInitialStageData(),
                        preparatory: getInitialStageData()
                    };
                    trashedTeachers = userData.trash || [];
                } else {
                    dataByStage = {
                        primary: getInitialStageData(),
                        intermediate: getInitialStageData(),
                        preparatory: getInitialStageData()
                    };
                    trashedTeachers = [];
                    // This part should not be reached due to the auth check, but as a fallback:
                    await setDoc(userDocRef, { ...docSnap.data(), dataByStage, trash: trashedTeachers });
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showToast("حدث خطأ أثناء تحميل بياناتك.", "error");
            } finally {
                isDataLoaded = true;
            }
        }
        
        async function saveUserData() {
            if (!currentUser || !isDataLoaded) return;
            const userDocRef = doc(db, "users", currentUser.uid);
            try {
                // Using updateDoc is correct here. The security rules now allow this operation.
                await updateDoc(userDocRef, { 
                    dataByStage: dataByStage, 
                    trash: trashedTeachers 
                });
                // showToast("تم حفظ التغييرات بنجاح!", "success"); // Optional: uncomment for success feedback
            } catch (error) {
                console.error("Error saving user data:", error);
                showToast("فشل حفظ التغييرات في قاعدة البيانات.", "error");
            }
        }

        stageSelector.addEventListener('change', () => {
            currentStage = stageSelector.value;
            if (currentStage) {
                stageContentContainer.classList.remove('hidden');
                updateAllUI();
                populateClassesContainer();
            } else {
                stageContentContainer.classList.add('hidden');
            }
        });

        function updateAllUI() {
            if (!currentStage) {
                document.getElementById('teacher-count-stat').textContent = 0;
                document.getElementById('session-count-stat').textContent = 0;
                document.getElementById('last-teachers-list').innerHTML = '<li class="text-center text-gray-400 text-pop">اختر مرحلة لعرض البيانات.</li>';
                generateScheduleBtn.disabled = true;
                showLastScheduleBtn.disabled = true;
                teacherSelect.innerHTML = '';
                return;
            }
            updateDashboardStats();
            updateTeacherSelect();
            const stageData = dataByStage[currentStage] || getInitialStageData();
            generateScheduleBtn.disabled = stageData.teachers.length === 0;
            showLastScheduleBtn.disabled = !(stageData.lastSchedule && stageData.lastSchedule.schedule);
        }

        function updateDashboardStats() {
            const stageData = dataByStage[currentStage] || getInitialStageData();
            const teachers = stageData.teachers;
            const teacherCountEl = document.getElementById('teacher-count-stat');
            const sessionCountEl = document.getElementById('session-count-stat');
            const lastTeachersListEl = document.getElementById('last-teachers-list');

            const totalSessions = teachers.reduce((acc, teacher) => {
                return acc + teacher.subjects.reduce((subAcc, subject) => {
                    return subAcc + subject.classes.reduce((classAcc, c) => classAcc + c.sessions, 0);
                }, 0);
            }, 0);

            teacherCountEl.textContent = teachers.length;
            sessionCountEl.textContent = totalSessions;

            lastTeachersListEl.innerHTML = '';
            const lastFive = teachers.slice(-5).reverse();
            if (lastFive.length > 0) {
                 lastFive.forEach(t => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-black/10 p-2 rounded-md text-pop";
                    const teacherColor = generateColorFromString(t.name);
                    const teacherTotalSessions = t.subjects.reduce((sum, subj) => sum + subj.classes.reduce((s, c) => s + c.sessions, 0), 0);
                    li.innerHTML = `
                        <span class="flex items-center gap-2">
                          <span class="w-3 h-3 rounded-full inline-block" style="background-color: ${teacherColor};"></span>
                          ${t.name}
                        </span>
                        <span class="text-xs font-mono bg-gray-700/50 px-2 py-1 rounded">${teacherTotalSessions} حصص</span>
                    `;
                    lastTeachersListEl.appendChild(li);
                });
            } else {
                lastTeachersListEl.innerHTML = '<p class="text-center text-gray-400 p-4 text-pop">لم تتم إضافة معلمين بعد.</p>';
            }
        }

        const stagesConfig = {
            primary: { name: 'ابتدائي', grades: ['1', '2', '3', '4', '5', '6'] },
            intermediate: { name: 'متوسط', grades: ['1', '2', '3'] },
            preparatory: { name: 'إعدادي', tracks: { scientific: { name: 'علمي', grades: ['الرابع', 'الخامس', 'السادس'] }, literary: { name: 'أدبي', grades: ['الرابع', 'الخامس', 'السادس'] } } }
        };

        function populateClassesContainer() {
            classesContainer.innerHTML = '';
            if (!currentStage) return;
            const stage = stagesConfig[currentStage];
            if (currentStage === 'preparatory') {
                const trackSelectContainer = document.createElement('div');
                trackSelectContainer.innerHTML = `<label for="track" class="block text-sm font-semibold mb-2 text-gray-300 text-pop">اختر المسار</label><select id="track" class="w-full p-3 bg-gray-900/50 border border-gray-600 rounded-lg text-white"><option value="">-- اختر --</option><option value="scientific">علمي</option><option value="literary">أدبي</option></select><div id="prep-classes-container" class="mt-4 space-y-3"></div>`;
                classesContainer.appendChild(trackSelectContainer);
                document.getElementById('track').addEventListener('change', (e) => {
                    const trackKey = e.target.value;
                    const prepContainer = document.getElementById('prep-classes-container');
                    prepContainer.innerHTML = '';
                    if (trackKey) stage.tracks[trackKey].grades.forEach(grade => createGradeUI(`${grade} ${stage.tracks[trackKey].name}`, prepContainer));
                });
            } else {
                stage.grades.forEach(grade => createGradeUI(`الصف ${grade} ${stage.name}`, classesContainer));
            }
        }

        function createGradeUI(gradeName, container) {
            const gradeId = `grade-${gradeName.replace(/\s+/g, '-')}`;
            const gradeDiv = document.createElement('div');
            gradeDiv.className = 'p-3 border border-gray-700/50 rounded-lg bg-black/10 space-y-3';
            gradeDiv.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-center"><label class="font-semibold text-gray-200 sm:col-span-1 text-pop">${gradeName}</label><input type="number" data-class-name="${gradeName}" class="class-session-input w-full p-2 text-center bg-gray-900/50 border border-gray-600 rounded-md sm:col-span-1 text-white" placeholder="عدد الحصص"><button type="button" class="add-section-btn text-sm bg-blue-500/20 text-blue-300 py-2 px-4 rounded-md hover:bg-blue-500/40 sm:col-span-1 text-pop">إضافة شعبة</button></div><div id="sections-for-${gradeId}" class="space-y-2 pr-4 border-r-2 border-gray-600"></div>`;
            container.appendChild(gradeDiv);
            gradeDiv.querySelector('.add-section-btn').addEventListener('click', () => addSectionInput(document.getElementById(`sections-for-${gradeId}`), gradeName));
        }

        function addSectionInput(container, gradeName) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'grid grid-cols-1 sm:grid-cols-3 gap-3 items-center';
            sectionDiv.innerHTML = `<input type="text" class="section-name-input w-full p-2 bg-gray-900/50 border border-gray-600 rounded-md sm:col-span-1 text-white" placeholder="اسم الشعبة (أ, ب)"><input type="number" data-grade-name="${gradeName}" class="class-session-input w-full p-2 text-center bg-gray-900/50 border border-gray-600 rounded-md sm:col-span-1 text-white" placeholder="عدد الحصص"><button type="button" class="remove-section-btn text-sm bg-red-500/20 text-red-300 py-2 px-4 rounded-md hover:bg-red-500/40 sm:col-span-1 text-pop">حذف الشعبة</button>`;
            container.appendChild(sectionDiv);
            sectionDiv.querySelector('.remove-section-btn').addEventListener('click', () => sectionDiv.remove());
        }

        teacherSelect.addEventListener('change', () => {
            if (teacherSelect.value === 'add_new') {
                newTeacherNameInput.classList.remove('hidden');
                newTeacherNameInput.focus();
            } else {
                newTeacherNameInput.classList.add('hidden');
                newTeacherNameInput.value = '';
            }
        });

        addTeacherForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentStage) {
                showToast('الرجاء اختيار مرحلة دراسية أولاً.', 'error');
                return;
            }
            
            let teacherName = (teacherSelect.value === 'add_new') ? newTeacherNameInput.value.trim() : teacherSelect.value;
            const subject = document.getElementById('subject').value.trim();
            if (!teacherName || !subject) { showToast('يرجى إدخال اسم المعلم والمادة.', 'error'); return; }

            const assignedClasses = [];
            document.querySelectorAll('.class-session-input').forEach(input => {
                const sessions = parseInt(input.value);
                if (sessions > 0) {
                    let className = input.dataset.className;
                    if (!className) {
                        const gradeName = input.dataset.gradeName;
                        const sectionName = input.parentElement.querySelector('.section-name-input').value.trim();
                        if (gradeName && sectionName) className = `${gradeName} - ${sectionName}`;
                    }
                    if(className) assignedClasses.push({ className, sessions });
                }
            });
            if (assignedClasses.length === 0) { showToast('يرجى تحديد حصص لصف واحد على الأقل.', 'error'); return; }
            
            const stageTeachers = dataByStage[currentStage].teachers;
            let existingTeacher = stageTeachers.find(t => t.name === teacherName);
            if (existingTeacher) {
                let existingSubject = existingTeacher.subjects.find(s => s.subjectName === subject);
                if (existingSubject) { showToast(`المادة "${subject}" موجودة بالفعل للمعلم "${teacherName}".`, 'error'); return; }
                existingTeacher.subjects.push({ subjectName: subject, classes: assignedClasses });
            } else {
                stageTeachers.push({ id: 't' + Date.now(), name: teacherName, subjects: [{ subjectName: subject, classes: assignedClasses }] });
            }
            
            saveUserData();
            updateAllUI();
            addTeacherForm.reset();
            newTeacherNameInput.classList.add('hidden'); 
            showToast('تمت إضافة النصاب بنجاح!', 'success');
        });

        function updateTeacherSelect() {
            const selectedValue = teacherSelect.value;
            teacherSelect.innerHTML = '<option value="">-- اختر معلماً --</option>';
            if (!currentStage) return;

            const stageTeachers = dataByStage[currentStage].teachers;
            const uniqueNames = [...new Set(stageTeachers.map(t => t.name))].sort();
            uniqueNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                teacherSelect.appendChild(option);
            });

            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new';
            addNewOption.textContent = '++ إضافة معلم جديد ++';
            addNewOption.className = 'font-bold text-violet-400';
            teacherSelect.appendChild(addNewOption);

            if (uniqueNames.includes(selectedValue)) {
                teacherSelect.value = selectedValue;
            }
        }

        showTeachersModalBtn.addEventListener('click', () => {
            if (!currentStage) { showToast('اختر مرحلة أولاً.', 'error'); return; }
            renderTeachersDataModal();
            teachersDataModal.classList.remove('hidden');
        });
        closeTeachersDataModalBtn.addEventListener('click', () => teachersDataModal.classList.add('hidden'));

        function renderTeachersDataModal() {
            teachersDataList.innerHTML = '';
            const teachers = dataByStage[currentStage].teachers;
            if (teachers.length === 0) {
                teachersDataList.innerHTML = '<p class="text-gray-400 text-center">لا يوجد معلمون لهذه المرحلة.</p>';
                return;
            }
            teachers.forEach(teacher => {
                const teacherColor = generateColorFromString(teacher.name);
                const totalSessions = teacher.subjects.reduce((sum, subj) => sum + subj.classes.reduce((s, c) => s + c.sessions, 0), 0);
                
                const detailsHtml = teacher.subjects.map(subj => `
                    <div class="mt-2 pl-4 border-l-4" style="border-color: ${teacherColor};">
                        <p class="font-semibold text-gray-200">${subj.subjectName} (${subj.classes.reduce((s, c) => s + c.sessions, 0)} حصص)</p>
                        <div class="text-xs text-gray-400 mt-1">${subj.classes.map(c => `${c.className} (${c.sessions})`).join(' | ')}</div>
                    </div>
                `).join('');

                const card = document.createElement('div');
                card.className = 'bg-gray-900/50 rounded-lg p-4 border border-gray-700';
                card.innerHTML = `
                    <details>
                        <summary class="flex justify-between items-center cursor-pointer">
                            <div class="font-bold text-lg text-white flex items-center">
                                <span class="w-4 h-4 rounded-full inline-block mr-3" style="background-color: ${teacherColor};"></span>
                                ${teacher.name}
                                <span class="font-semibold text-gray-300 text-base ml-4">(إجمالي الحصص: ${totalSessions})</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-id="${teacher.id}" class="edit-teacher-btn text-blue-400 hover:text-blue-300 p-2"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${teacher.id}" class="move-teacher-to-trash-btn text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </summary>
                        <div class="mt-3 pr-4 space-y-2">${detailsHtml}</div>
                    </details>
                `;
                teachersDataList.appendChild(card);
            });

            document.querySelectorAll('.edit-teacher-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(e.currentTarget.dataset.id); }));
            document.querySelectorAll('.move-teacher-to-trash-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('هل أنت متأكد من نقل هذا المعلم إلى سلة المهملات؟')) {
                    const teacherId = e.currentTarget.dataset.id;
                    const teachers = dataByStage[currentStage].teachers;
                    const teacherIndex = teachers.findIndex(t => t.id === teacherId);
                    if (teacherIndex > -1) {
                        const [teacherToTrash] = teachers.splice(teacherIndex, 1);
                        teacherToTrash.deletedAt = Date.now();
                        teacherToTrash.stage = currentStage;
                        trashedTeachers.push(teacherToTrash);
                        saveUserData();
                        renderTeachersDataModal();
                        updateAllUI();
                    }
                }
            }));
        }
        
        closeEditTeacherModalBtn.addEventListener('click', () => editTeacherModal.classList.add('hidden'));

        function openEditModal(teacherId) {
            const teacher = dataByStage[currentStage].teachers.find(t => t.id === teacherId);
            if (!teacher) return;
            const container = document.getElementById('edit-teacher-form-container');
            container.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-300">اسم المعلم</label>
                        <input type="text" id="edit-teacher-name" value="${teacher.name}" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    </div>
                    <h3 class="text-lg font-bold pt-4 border-t border-gray-700">المواد المسندة</h3>
                    <div id="edit-subjects-list" class="space-y-3">
                        ${teacher.subjects.map((subject, index) => `
                            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold">${subject.subjectName}</p>
                                    <button data-id="${teacher.id}" data-subject-index="${index}" class="remove-subject-btn text-red-400 hover:text-red-300">&times; حذف المادة</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-center pt-4">
                        <button data-id="${teacher.id}" id="save-teacher-changes-btn" class="bg-green-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-green-700">حفظ التغييرات</button>
                    </div>
                </div>
            `;
            editTeacherModal.classList.remove('hidden');

            document.getElementById('save-teacher-changes-btn').addEventListener('click', saveTeacherChanges);
            document.querySelectorAll('.remove-subject-btn').forEach(btn => btn.addEventListener('click', removeSubjectFromTeacher));
        }

        function saveTeacherChanges(e) {
            const teacherId = e.currentTarget.dataset.id;
            const teacher = dataByStage[currentStage].teachers.find(t => t.id === teacherId);
            if (!teacher) return;

            const newName = document.getElementById('edit-teacher-name').value.trim();
            if (!newName) { showToast('اسم المعلم لا يمكن أن يكون فارغاً.', 'error'); return; }
            teacher.name = newName;
            saveUserData();
            updateAllUI();
            renderTeachersDataModal();
            editTeacherModal.classList.add('hidden');
            showToast('تم حفظ التغييرات بنجاح.', 'success');
        }

        function removeSubjectFromTeacher(e) {
            const { id, subjectIndex } = e.currentTarget.dataset;
            const teachers = dataByStage[currentStage].teachers;
            const teacher = teachers.find(t => t.id === id);
            if (teacher) {
                teacher.subjects.splice(subjectIndex, 1);
                if (teacher.subjects.length === 0) {
                    dataByStage[currentStage].teachers = teachers.filter(t => t.id !== id);
                    editTeacherModal.classList.add('hidden');
                } else {
                    openEditModal(id);
                }
                saveUserData();
                updateAllUI();
                renderTeachersDataModal();
            }
        }

        trashBtn.addEventListener('click', () => { loadTrashItems(); trashModal.classList.remove('hidden'); });
        closeTrashModalBtn.addEventListener('click', () => { trashModal.classList.add('hidden'); });

        function loadTrashItems() {
            trashListDiv.innerHTML = '';
            const now = Date.now();
            const sevenDays = 7 * 24 * 60 * 60 * 1000;
            trashedTeachers = trashedTeachers.filter(t => (now - t.deletedAt) < sevenDays);
            saveUserData();
            if (trashedTeachers.length === 0) { trashListDiv.innerHTML = '<p class="text-gray-400 text-center">سلة المهملات فارغة.</p>'; return; }
            trashedTeachers.forEach(teacher => {
                const daysLeft = Math.ceil((sevenDays - (now - teacher.deletedAt)) / (1000 * 60 * 60 * 24));
                const stageName = stagesConfig[teacher.stage]?.name || 'غير معروف';
                const trashItemDiv = document.createElement('div');
                trashItemDiv.className = 'flex justify-between items-center p-3 bg-gray-900/50 rounded-lg';
                trashItemDiv.innerHTML = `<div><p class="font-semibold">${teacher.name} <span class="text-xs text-gray-400">(${stageName})</span></p><p class="text-xs text-red-400">سيتم الحذف نهائياً خلال ${daysLeft} أيام</p></div><div class="flex gap-2"><button data-id="${teacher.id}" class="restore-btn bg-green-500/20 text-green-300 py-1 px-3 rounded-md text-sm hover:bg-green-500/40">استعادة</button><button data-id="${teacher.id}" class="perm-delete-btn bg-red-500/20 text-red-300 py-1 px-3 rounded-md text-sm hover:bg-red-500/40">حذف نهائي</button></div>`;
                trashListDiv.appendChild(trashItemDiv);
            });
            document.querySelectorAll('.restore-btn').forEach(btn => btn.addEventListener('click', restoreFromTrash));
            document.querySelectorAll('.perm-delete-btn').forEach(btn => btn.addEventListener('click', deletePermanently));
        }

        function restoreFromTrash(e) {
            const id = e.currentTarget.dataset.id;
            const trashIndex = trashedTeachers.findIndex(t => t.id === id);
            if (trashIndex > -1) {
                const [restoredTeacher] = trashedTeachers.splice(trashIndex, 1);
                const originalStage = restoredTeacher.stage;
                if (originalStage && dataByStage[originalStage]) {
                    delete restoredTeacher.deletedAt;
                    delete restoredTeacher.stage;
                    dataByStage[originalStage].teachers.push(restoredTeacher);
                    saveUserData(); 
                    updateAllUI();
                    loadTrashItems();
                    showToast(`تمت استعادة المعلم إلى مرحلة ${stagesConfig[originalStage].name}.`, 'success');
                } else {
                     showToast('خطأ: لا يمكن استعادة المعلم إلى مرحلة غير موجودة.', 'error');
                     trashedTeachers.push(restoredTeacher);
                }
            }
        }
        function deletePermanently(e) {
            const id = e.currentTarget.dataset.id;
            if (confirm('هل أنت متأكد من الحذف النهائي؟ لا يمكن التراجع عن هذا الإجراء.')) {
                trashedTeachers = trashedTeachers.filter(t => t.id !== id);
                saveUserData(); loadTrashItems();
            }
        }

        const handleGenerate = () => {
            const teachers = dataByStage[currentStage].teachers;
            if (teachers.length === 0) {
                showToast('الرجاء إضافة معلم واحد على الأقل لهذه المرحلة أولاً.', 'error');
                return;
            }
            const bestSchedule = generateAndDisplaySchedule(teachers);
            dataByStage[currentStage].lastSchedule = bestSchedule;
            saveUserData();
            renderFinalScheduleLayout();
            displayUnscheduled(bestSchedule.unscheduledList);
            showLastScheduleBtn.disabled = !(bestSchedule && bestSchedule.schedule);
        };

        generateScheduleBtn.addEventListener('click', () => {
            if (!currentStage) { showToast('اختر مرحلة أولاً.', 'error'); return; }
            handleGenerate();
            mainAppContainer.classList.add('hidden');
            mainAppContainer.classList.remove('flex');
            pageSchedule.classList.remove('hidden');
            pageSchedule.classList.add('full-screen');
        });
        regenerateBtn.addEventListener('click', handleGenerate);
        backToMainAppBtn.addEventListener('click', () => {
            pageSchedule.classList.add('hidden');
            pageSchedule.classList.remove('full-screen');
            mainAppContainer.classList.remove('hidden');
            mainAppContainer.classList.add('flex');
        });
        
        downloadImageBtn.addEventListener('click', () => {
            showToast('جاري تحضير الصورة...', 'success');
            const printArea = document.getElementById('schedule-print-area');
            const table = printArea.querySelector('.schedule-table');
            if (!table) return;

            const cellsToRestore = [];
            table.querySelectorAll('td.day-cell[rowspan]').forEach(cell => {
                const rowspan = parseInt(cell.getAttribute('rowspan'), 10);
                if (rowspan > 1) {
                    let currentRow = cell.parentElement;
                    cellsToRestore.push({ cell: cell, rowspan: rowspan });
                    cell.removeAttribute('rowspan');
                    
                    for (let i = 1; i < rowspan; i++) {
                        currentRow = currentRow.nextElementSibling;
                        if (currentRow) {
                            const newCell = document.createElement('td');
                            newCell.className = cell.className;
                            newCell.style.backgroundColor = window.getComputedStyle(cell).backgroundColor;
                            newCell.innerHTML = cell.innerHTML;
                            newCell.dataset.tempForPrint = 'true';
                            currentRow.insertBefore(newCell, currentRow.cells[0]);
                        }
                    }
                }
            });

            html2canvas(printArea, { scale: 2.5, backgroundColor: '#ffffff', useCORS: true, logging: false }).then(canvas => {
                const link = document.createElement('a');
                link.download = `جدول-${stagesConfig[currentStage].name}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).finally(() => {
                cellsToRestore.forEach(item => {
                    item.cell.setAttribute('rowspan', item.rowspan);
                });
                table.querySelectorAll('td[data-temp-for-print="true"]').forEach(cell => cell.remove());
            });
        });
        
        showLastScheduleBtn.addEventListener('click', () => {
            if (!currentStage) { showToast('اختر مرحلة أولاً.', 'error'); return; }
            const lastSchedule = dataByStage[currentStage].lastSchedule;
            if (lastSchedule && lastSchedule.schedule) {
                renderFinalScheduleLayout();
                displayUnscheduled(lastSchedule.unscheduledList || []);
                mainAppContainer.classList.add('hidden');
                mainAppContainer.classList.remove('flex');
                pageSchedule.classList.remove('hidden');
                pageSchedule.classList.add('full-screen');
            } else {
                showToast('لا يوجد جدول محفوظ لهذه المرحلة.', 'error');
            }
        });
        
        function generateAndDisplaySchedule(teachers) {
            let bestResult = { unscheduledCount: Infinity, penalty: Infinity };
            const attempts = 10;
            for (let i = 0; i < attempts; i++) {
                const result = attemptScheduling(teachers);
                if (result.unscheduledCount < bestResult.unscheduledCount || (result.unscheduledCount === bestResult.unscheduledCount && result.penalty < bestResult.penalty)) {
                    bestResult = result;
                }
                if (bestResult.unscheduledCount === 0 && bestResult.penalty < 50) break;
            }
            return bestResult;
        }

        function attemptScheduling(teachers) {
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
            const periods = 6;
            const allClassNames = [...new Set(teachers.flatMap(t => t.subjects.flatMap(s => s.classes.map(c => c.className))))].sort();
            
            let scheduleGrid = {};
            allClassNames.forEach(name => { scheduleGrid[name] = Array(days.length).fill(0).map(() => Array(periods).fill(null)); });
            let teacherTimeSlots = {}; 

            const teacherTotals = {};
            teachers.forEach(t => {
                teacherTotals[t.name] = t.subjects.reduce((sum, subj) => sum + subj.classes.reduce((s, c) => s + c.sessions, 0), 0);
            });

            let sessionsToPlace = [];
            teachers.forEach(teacher => {
                teacher.subjects.forEach(subject => {
                    subject.classes.forEach(c => {
                        for (let i = 0; i < c.sessions; i++) {
                            sessionsToPlace.push({ teacher: teacher.name, subject: subject.subjectName, className: c.className });
                        }
                    });
                });
            });
            
            sessionsToPlace.sort((a, b) => teacherTotals[b.teacher] - teacherTotals[a.teacher]);

            let totalPenalty = 0;
            let unscheduledSessions = [];

            sessionsToPlace.forEach(session => {
                let bestSlot = { day: -1, period: -1, penalty: Infinity };

                const shuffledDays = [...days.keys()].sort(() => Math.random() - 0.5);
                const shuffledPeriods = [...Array(periods).keys()].sort(() => Math.random() - 0.5);

                for (const d of shuffledDays) {
                    for (const p of shuffledPeriods) {
                        if (scheduleGrid[session.className][d][p] !== null) continue; 
                        if (teacherTimeSlots[`${d}-${p}`] && teacherTimeSlots[`${d}-${p}`].has(session.teacher)) continue; 
                        
                        let currentPenalty = 0;
                        
                        let dailyLoad = 0;
                        for (let i = 0; i < periods; i++) {
                            if (teacherTimeSlots[`${d}-${i}`] && teacherTimeSlots[`${d}-${i}`].has(session.teacher)) {
                                dailyLoad++;
                            }
                        }
                        const avgLoad = teacherTotals[session.teacher] / days.length;
                        if (dailyLoad >= Math.ceil(avgLoad)) {
                            currentPenalty += Math.pow(25, dailyLoad - avgLoad + 1);
                        }

                        const prevTeacherSession = p > 0 && teacherTimeSlots[`${d}-${p-1}`]?.has(session.teacher);
                        if (prevTeacherSession) {
                            currentPenalty += 50;
                            const prevPrevTeacherSession = p > 1 && teacherTimeSlots[`${d}-${p-2}`]?.has(session.teacher);
                            if (prevPrevTeacherSession) {
                                currentPenalty += 150;
                            }
                        }
                        
                        const isArtOrPE = session.subject.includes('فنية') || session.subject.includes('رياضة');
                        const isUpperGrade = session.className.includes('خامس') || session.className.includes('سادس') || session.className.includes('الخامس') || session.className.includes('السادس');
                        if (isArtOrPE && isUpperGrade) {
                            if (p < periods - 2) currentPenalty += 40;
                        }

                        if (scheduleGrid[session.className][d].some(s => s && s.subject === session.subject)) {
                            currentPenalty += 250;
                        }

                        if (currentPenalty < bestSlot.penalty) {
                            bestSlot = { day: d, period: p, penalty: currentPenalty };
                        }
                    }
                }

                if (bestSlot.day !== -1) {
                    const { day, period, penalty } = bestSlot;
                    scheduleGrid[session.className][day][period] = { subject: session.subject, teacher: session.teacher };
                    if (!teacherTimeSlots[`${day}-${period}`]) {
                        teacherTimeSlots[`${day}-${period}`] = new Set();
                    }
                    teacherTimeSlots[`${day}-${period}`].add(session.teacher);
                    totalPenalty += penalty;
                } else {
                    unscheduledSessions.push(session);
                }
            });

            return {
                schedule: scheduleGrid,
                unscheduledCount: unscheduledSessions.length,
                unscheduledList: unscheduledSessions,
                penalty: totalPenalty,
                classNames: allClassNames,
                days: days,
                periods: periods
            };
        }
        
        function displayUnscheduled(unscheduledList) {
            const unscheduledContainer = document.getElementById('unscheduled-sessions');
            const listElement = document.getElementById('unscheduled-list');
            unscheduledContainer.classList.toggle('hidden', unscheduledList.length === 0);
            if (unscheduledList.length > 0) listElement.innerHTML = unscheduledList.map(s => `<li>${s.subject} - ${s.teacher} (${s.className})</li>`).join('');
        }

        function renderFinalScheduleLayout() {
            const lastSchedule = dataByStage[currentStage].lastSchedule;
            if (!lastSchedule) return;
            
            const stageName = stagesConfig[currentStage].name;
            document.getElementById('schedule-page-title').textContent = `الجدول الأسبوعي - مرحلة ${stageName}`;
            document.getElementById('print-title').textContent = `الجدول الدراسي الأسبوعي - مرحلة ${stageName}`;

            const { schedule, classNames, days, periods } = lastSchedule;
            let tableHtml = `<table class="schedule-table"><thead><tr><th rowspan="2" class="w-24">اليوم</th><th rowspan="2" class="w-16">الدرس</th>`;
            classNames.forEach(name => { tableHtml += `<th colspan="2">${name}</th>`; });
            tableHtml += `</tr><tr>`;
            classNames.forEach(() => { tableHtml += `<th>المادة</th><th>المعلم</th>`; });
            tableHtml += `</tr></thead><tbody id="schedule-body">`;
            days.forEach((day, d) => {
                for (let p = 0; p < periods; p++) {
                    tableHtml += `<tr class="day-row day-row-${d}">`;
                    if (p === 0) tableHtml += `<td class="day-cell" rowspan="${periods}">${day}</td>`;
                    tableHtml += `<td class="period-cell">${p + 1}</td>`;
                    classNames.forEach((className) => {
                        const sessionData = schedule[className]?.[d]?.[p];
                        const dataAttrs = `data-day="${d}" data-period="${p}" data-class-name="${className}"`;
                        if (sessionData) {
                            tableHtml += `<td class="session-cell" ${dataAttrs}>${sessionData.subject}</td>
                                        <td class="teacher-cell">${sessionData.teacher}</td>`;
                        } else {
                            tableHtml += `<td class="empty-cell" ${dataAttrs}></td>
                                        <td class="empty-cell"></td>`;
                        }
                    });
                    tableHtml += `</tr>`;
                }
            });
            tableHtml += `</tbody></table>`;
            scheduleContainer.innerHTML = tableHtml;
            initDragAndDrop();
        }
        
        function initDragAndDrop() {
            if (sortableInstance) sortableInstance.destroy();
            const tableBody = document.getElementById('schedule-body');
            if (!tableBody) return;
            sortableInstance = new Sortable(tableBody, {
                group: 'schedule-cells',
                animation: 150,
                ghostClass: 'sortable-ghost',
                draggable: '.session-cell',
                filter: '.empty-cell',
                preventOnFilter: true,
                onEnd: handleDrop,
            });
        }

        function handleDrop(evt) {
            const fromCell = evt.item;
            const toCell = evt.to.children[evt.newDraggableIndex];

            if (!toCell || !toCell.classList.contains('empty-cell')) {
                showToast('لا يمكن النقل إلى خانة مشغولة.', 'error');
                 evt.from.insertBefore(fromCell, evt.from.children[evt.oldIndex]);
                return;
            }

            const fromDay = parseInt(fromCell.dataset.day);
            const fromPeriod = parseInt(fromCell.dataset.period);
            const fromClassName = fromCell.dataset.className;

            const toDay = parseInt(toCell.dataset.day);
            const toPeriod = parseInt(toCell.dataset.period);
            const toClassName = toCell.dataset.className;

            if (fromClassName !== toClassName) {
                showToast('لا يمكن نقل الحصة إلى صف دراسي مختلف.', 'error');
                evt.from.insertBefore(fromCell, evt.from.children[evt.oldIndex]);
                return;
            }
            
            const lastSchedule = dataByStage[currentStage].lastSchedule;
            const sessionToMove = { ...lastSchedule.schedule[fromClassName][fromDay][fromPeriod] };
            
            for (const className of lastSchedule.classNames) {
                 if (className === fromClassName) continue; 
                 const conflictSession = lastSchedule.schedule[className][toDay][toPeriod];
                 if(conflictSession && conflictSession.teacher === sessionToMove.teacher) {
                     showToast(`تعارض: المعلم ${sessionToMove.teacher} لديه حصة أخرى في هذا الوقت.`, 'error');
                     evt.from.insertBefore(fromCell, evt.from.children[evt.oldIndex]);
                     return;
                 }
            }
            
            lastSchedule.schedule[fromClassName][fromDay][fromPeriod] = null;
            lastSchedule.schedule[toClassName][toDay][toPeriod] = sessionToMove;

            showToast('تم نقل الحصة بنجاح.', 'success');
            saveUserData();
            renderFinalScheduleLayout();
        }

        showStatsBtn.addEventListener('click', () => {
            if (!currentStage || !dataByStage[currentStage].lastSchedule) {
                showToast('يجب توليد جدول لهذه المرحلة أولاً.', 'error');
                return;
            }
            generateAndShowStats();
            statsModal.classList.remove('hidden');
        });
        closeStatsModalBtn.addEventListener('click', () => statsModal.classList.add('hidden'));

        function generateAndShowStats() {
            const { lastSchedule, teachers } = dataByStage[currentStage];
            if (!lastSchedule) return;
            const stats = {};
            const { schedule, classNames, days, periods } = lastSchedule;
            const lastPeriodIndex = periods - 1;

            teachers.forEach(teacher => {
                stats[teacher.name] = { total: 0, lastPeriods: 0, subjects: {} };
                teacher.subjects.forEach(subject => {
                    stats[teacher.name].subjects[subject.subjectName] = { total: 0 };
                });
            });

            for (let d = 0; d < days.length; d++) {
                for (let p = 0; p < periods; p++) {
                    for (const className of classNames) {
                        const session = schedule[className]?.[d]?.[p];
                        if (session && stats[session.teacher]) {
                            if (!stats[session.teacher].subjects[session.subject]) {
                                stats[session.teacher].subjects[session.subject] = { total: 0 };
                            }
                            stats[session.teacher].total++;
                            stats[session.teacher].subjects[session.subject].total++;
                            if (p === lastPeriodIndex) {
                                stats[session.teacher].lastPeriods++;
                            }
                        }
                    }
                }
            }
            renderStatsDetails(stats);
            renderStatsChart(stats);
        }

        function renderStatsDetails(stats) {
            const container = document.getElementById('teacher-stats-details-container');
            container.innerHTML = '<h3 class="text-lg font-bold mb-4">تفاصيل نصاب المعلمين</h3>';
            const teacherNames = Object.keys(stats).sort();

            if (teacherNames.length === 0) {
                container.innerHTML += '<p class="text-gray-400">لا توجد بيانات لعرضها.</p>';
                return;
            }

            teacherNames.forEach(name => {
                const data = stats[name];
                const teacherColor = generateColorFromString(name);
                let subjectsHtml = Object.keys(data.subjects).sort().map(subjectName => `<li class="flex justify-between items-center text-sm py-1"><span>${subjectName}</span><span class="font-semibold bg-gray-600 px-2 rounded">${data.subjects[subjectName].total} حصص</span></li>`).join('');
                const cardHtml = `<div class="bg-gray-700/50 border border-gray-600 rounded-lg p-4 mb-4 shadow"><div class="flex justify-between items-center border-b pb-2 mb-2" style="border-color: ${teacherColor};"><h4 class="font-bold text-lg" style="color: ${teacherColor};">${name}</h4><div class="text-right"><p class="font-bold text-xl">${data.total} <span class="text-sm font-normal">حصة</span></p><p class="text-xs text-gray-400">منها ${data.lastPeriods} حصص أخيرة</p></div></div><ul class="space-y-1">${subjectsHtml}</ul></div>`;
                container.innerHTML += cardHtml;
            });
        }

        function renderStatsChart(stats) {
            const ctx = document.getElementById('teacher-load-chart').getContext('2d');
            const teacherNames = Object.keys(stats).sort();
            const data = teacherNames.map(name => stats[name].total);
            const backgroundColors = teacherNames.map(name => generateColorFromString(name, 0.7));
            const borderColors = teacherNames.map(name => generateColorFromString(name, 1));
            
            Chart.defaults.color = '#e5e7eb';
            
            if (teacherStatsChart) teacherStatsChart.destroy();
            teacherStatsChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: teacherNames, datasets: [{ label: 'إجمالي عدد الحصص', data: data, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 2, color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, 
                    plugins: { legend: { display: false } } 
                }
            });
        }

        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = 'show';
            toast.classList.add(type);
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }

        function generateColorFromString(str, alpha = 0.8) {
            let hash = 0;
            if (!str) return `rgba(200, 200, 200, ${alpha})`;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
    });
</script>
</body>
</html>
